{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import express from \"express\";\nimport { initializeIDE, isIDERunning } from \"./ide\";\nimport { callbackHandler, createSessionToken } from \"./auth\";\nconst dotenv = require(\"dotenv\");\nimport cookieParser from \"cookie-parser\";\nimport jwt from \"jsonwebtoken\";\nimport cors from 'cors'\n\nconst app = express();\ndotenv.config();\n\napp.use(express.json());\napp.use(express.urlencoded({ extended: true }));\napp.use(cookieParser());\napp.use(cors())\n\napp.get(\"/\", (req, res) => {\n  res.send(\"Hello World!\");\n});\n\napp.get(\"/auth/github\", (req, res) => {\n  const clientId = process.env.GITHUB_CLIENT_ID;\n  res.redirect(\n    `https://github.com/login/oauth/authorize?client_id=${clientId}&scope=user`\n  );\n});\napp.get(\"/auth/callback\", (req, res) => callbackHandler(req, res));\n\napp.get(\"/auth/whoami\", async (req, res) => {\n  let token = req.cookies.auth_token;\n\n  if (!token) {\n    return res.status(404).send(\"unauthorized\")\n  }\n\n  token = jwt.verify(token, process.env.JWT_SECRET as string);\n\n  if (!token) {\n    return res.status(404).send(\"unauthorized\")\n  }\n\n  return res.status(200).send(token);\n})\n\napp.get(\"/ide/create\", async (req, res) => {\n  let token = req.cookies.auth_token;\n  token = jwt.verify(token, process.env.JWT_SECRET as string);\n\n  const ideResponse = await initializeIDE(token.id);\n\n  if (ideResponse.status === \"created\") {\n    if (ideResponse.clusterIP) {\n      res.cookie(\n        \"session_token\",\n        createSessionToken(ideResponse.clusterIP, token.id),\n        {\n          httpOnly: true,\n          domain: \".codelaunch.sh\",\n        }\n      );\n    }\n  }\n\n  res.status(200).send(ideResponse.status);\n});\n\napp.get(\"/ide/status\", async (req, res) => {\n  let token = req.cookies.auth_token;\n  token = jwt.verify(token, process.env.JWT_SECRET as string);\n\n  if (!token) {\n    return res.status(404).send(\"Unauthorized\")\n  }\n\n  const isRunning = await isIDERunning(token.id);\n\n  return res.status(200).send(isRunning);\n});\n\napp.listen(8000, () => {\n  console.log(\"listening at port 8000\");\n});\n"],"names":["dotenv","require","app","express","config","use","json","urlencoded","extended","cookieParser","cors","get","req","res","send","clientId","process","env","GITHUB_CLIENT_ID","redirect","callbackHandler","token","cookies","auth_token","status","jwt","verify","JWT_SECRET","ideResponse","initializeIDE","id","clusterIP","cookie","createSessionToken","httpOnly","domain","isRunning","isIDERunning","listen","console","log"],"mappings":"AAAA;;;;gDAAoB;qBACwB;sBACQ;qDAE3B;qDACT;6CACC;;;;;;AAHjB,MAAMA,SAASC,QAAQ;AAKvB,MAAMC,MAAMC,IAAAA,gBAAO;AACnBH,OAAOI,MAAM;AAEbF,IAAIG,GAAG,CAACF,gBAAO,CAACG,IAAI;AACpBJ,IAAIG,GAAG,CAACF,gBAAO,CAACI,UAAU,CAAC;IAAEC,UAAU,IAAI;AAAC;AAC5CN,IAAIG,GAAG,CAACI,IAAAA,qBAAY;AACpBP,IAAIG,GAAG,CAACK,IAAAA,aAAI;AAEZR,IAAIS,GAAG,CAAC,KAAK,CAACC,KAAKC,MAAQ;IACzBA,IAAIC,IAAI,CAAC;AACX;AAEAZ,IAAIS,GAAG,CAAC,gBAAgB,CAACC,KAAKC,MAAQ;IACpC,MAAME,WAAWC,QAAQC,GAAG,CAACC,gBAAgB;IAC7CL,IAAIM,QAAQ,CACV,CAAC,mDAAmD,EAAEJ,SAAS,WAAW,CAAC;AAE/E;AACAb,IAAIS,GAAG,CAAC,kBAAkB,CAACC,KAAKC,MAAQO,IAAAA,qBAAe,EAACR,KAAKC;AAE7DX,IAAIS,GAAG,CAAC,gBAAgB,OAAOC,KAAKC,MAAQ;IAC1C,IAAIQ,QAAQT,IAAIU,OAAO,CAACC,UAAU;IAElC,IAAI,CAACF,OAAO;QACV,OAAOR,IAAIW,MAAM,CAAC,KAAKV,IAAI,CAAC;IAC9B,CAAC;IAEDO,QAAQI,qBAAG,CAACC,MAAM,CAACL,OAAOL,QAAQC,GAAG,CAACU,UAAU;IAEhD,IAAI,CAACN,OAAO;QACV,OAAOR,IAAIW,MAAM,CAAC,KAAKV,IAAI,CAAC;IAC9B,CAAC;IAED,OAAOD,IAAIW,MAAM,CAAC,KAAKV,IAAI,CAACO;AAC9B;AAEAnB,IAAIS,GAAG,CAAC,eAAe,OAAOC,KAAKC,MAAQ;IACzC,IAAIQ,QAAQT,IAAIU,OAAO,CAACC,UAAU;IAClCF,QAAQI,qBAAG,CAACC,MAAM,CAACL,OAAOL,QAAQC,GAAG,CAACU,UAAU;IAEhD,MAAMC,cAAc,MAAMC,IAAAA,kBAAa,EAACR,MAAMS,EAAE;IAEhD,IAAIF,YAAYJ,MAAM,KAAK,WAAW;QACpC,IAAII,YAAYG,SAAS,EAAE;YACzBlB,IAAImB,MAAM,CACR,iBACAC,IAAAA,wBAAkB,EAACL,YAAYG,SAAS,EAAEV,MAAMS,EAAE,GAClD;gBACEI,UAAU,IAAI;gBACdC,QAAQ;YACV;QAEJ,CAAC;IACH,CAAC;IAEDtB,IAAIW,MAAM,CAAC,KAAKV,IAAI,CAACc,YAAYJ,MAAM;AACzC;AAEAtB,IAAIS,GAAG,CAAC,eAAe,OAAOC,KAAKC,MAAQ;IACzC,IAAIQ,QAAQT,IAAIU,OAAO,CAACC,UAAU;IAClCF,QAAQI,qBAAG,CAACC,MAAM,CAACL,OAAOL,QAAQC,GAAG,CAACU,UAAU;IAEhD,IAAI,CAACN,OAAO;QACV,OAAOR,IAAIW,MAAM,CAAC,KAAKV,IAAI,CAAC;IAC9B,CAAC;IAED,MAAMsB,YAAY,MAAMC,IAAAA,iBAAY,EAAChB,MAAMS,EAAE;IAE7C,OAAOjB,IAAIW,MAAM,CAAC,KAAKV,IAAI,CAACsB;AAC9B;AAEAlC,IAAIoC,MAAM,CAAC,MAAM,IAAM;IACrBC,QAAQC,GAAG,CAAC;AACd"}